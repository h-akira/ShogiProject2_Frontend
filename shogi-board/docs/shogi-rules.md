# 将棋ルール・KIF形式・SFEN形式 仕様書

本ドキュメントは、将棋盤コンポーネントの実装に必要な将棋ルール、KIF形式、SFEN形式の仕様をまとめたものである。

---

## 1. 将棋の基本ルール

### 1.1 盤面と座標系

- 盤面は **9×9** の81マス
- 座標表記: 筋（列）は右から **1〜9**、段（行）は上から **一〜九**
- 先手は盤の下側（九段側）、後手は盤の上側（一段側）
- 先手の敵陣: 一段〜三段、後手の敵陣: 七段〜九段

```
  ９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
|                           | 一  ← 後手陣（後手の敵陣ではない）
|        後手の陣地          | 二
|                           | 三  ← 先手の敵陣
+---------------------------+
|                           | 四
|        中立地帯            | 五
|                           | 六
+---------------------------+
|                           | 七  ← 後手の敵陣
|        先手の陣地          | 八
|                           | 九  ← 先手陣
+---------------------------+
```

### 1.2 駒の種類と枚数

| 駒名 | 略称 | 成駒名 | 枚数（片方） | 合計 |
|------|------|--------|-------------|------|
| 王将/玉将 | 玉/王 | （成れない） | 1 | 2 |
| 飛車 | 飛 | 龍王（龍） | 1 | 2 |
| 角行 | 角 | 龍馬（馬） | 1 | 2 |
| 金将 | 金 | （成れない） | 2 | 4 |
| 銀将 | 銀 | 成銀 | 2 | 4 |
| 桂馬 | 桂 | 成桂 | 2 | 4 |
| 香車 | 香 | 成香 | 2 | 4 |
| 歩兵 | 歩 | と金（と） | 9 | 18 |

**合計: 40枚**

### 1.3 各駒の動き方

座標系: 先手目線で `(dx, dy)`。dx=右が正、dy=前方（上）が正とする。

#### 玉将（King） — 1マス移動、全8方向

```
＼↑／
←玉→
／↓＼
```

方向ベクトル: `(-1,1), (0,1), (1,1), (-1,0), (1,0), (-1,-1), (0,-1), (1,-1)`

#### 飛車（Rook） — 走り駒、上下左右

```
  ↑
←飛→
  ↓
```

上下左右に何マスでも進める（途中に駒があると止まる）

#### 龍王（成飛車） — 飛車 + 斜め1マス

```
＼↑／
←龍→
／↓＼
```

飛車の走りに加え、斜め4方向に1マス移動可能

#### 角行（Bishop） — 走り駒、斜め4方向

```
＼  ／
  角
／  ＼
```

斜め4方向に何マスでも進める（途中に駒があると止まる）

#### 龍馬（成角行） — 角行 + 上下左右1マス

```
＼↑／
←馬→
／↓＼
```

角行の走りに加え、上下左右4方向に1マス移動可能

#### 金将（Gold） — 1マス移動、6方向

```
＼↑／
←金→
  ↓
```

前方3方向 + 左右 + 真後ろ = 6方向。**斜め後ろには進めない。**

#### 銀将（Silver） — 1マス移動、5方向

```
＼↑／
  銀
／  ＼
```

前方3方向 + 斜め後ろ2方向 = 5方向。**横と真後ろには進めない。**

#### 桂馬（Knight） — 跳び駒、前方2方向

```
○  ○

  桂
```

前方2マス+左右1マスの2方向のみ。途中の駒を飛び越えられる唯一の駒。

方向ベクトル: `(-1, 2), (1, 2)` （先手目線）

#### 香車（Lance） — 走り駒、前方のみ

```
  ↑
  香
```

前方に何マスでも進める。後退・横移動は不可。

#### 歩兵（Pawn） — 1マス移動、前方のみ

```
  ↑
  歩
```

前方に1マスのみ。

#### 成駒の動き

以下は全て **金将と同じ動き**:
- と金（成歩）
- 成香
- 成桂
- 成銀

### 1.4 駒の移動ルール

1. **手番**: 先手と後手が交互に1手ずつ指す。パス不可。
2. **味方の駒**: 味方の駒がいるマスには移動できない。
3. **敵駒の取得**: 相手の駒がいるマスに移動→その駒を取る。成り状態は解除され持ち駒に加わる。
4. **走り駒の障害物**: 途中に駒があるとそこで止まる。敵駒なら取れる、味方なら手前まで。
5. **桂馬の跳び**: 途中の駒を飛び越えて移動可能。

### 1.5 成りのルール

#### 成れる駒
飛車、角行、銀将、桂馬、香車、歩兵の6種類。**王将と金将は成れない。**

#### 成りの条件
盤上の駒を移動する際に、以下のいずれかを満たす場合:
1. **移動先が敵陣内**
2. **移動元が敵陣内**（敵陣内で動く場合、敵陣から出る場合を含む）

**持ち駒を打つ際は成れない。**

#### 強制成り

移動後にその駒が進める先が一切ない場合、必ず成らなければならない:

| 駒 | 先手の強制成り | 後手の強制成り |
|----|--------------|--------------|
| 歩 | 一段目に進む場合 | 九段目に進む場合 |
| 香 | 一段目に進む場合 | 九段目に進む場合 |
| 桂 | 一段目または二段目に進む場合 | 九段目または八段目に進む場合 |

### 1.6 持ち駒を打つルール

1. 自分の持ち駒から1枚を選び、盤上の**空きマス**に置く
2. 駒があるマスには打てない（味方・敵問わず）
3. 打った駒は必ず**不成の状態**で置く
4. **行き場のない場所への打ちの禁止**:
   - 先手: 歩・香は一段目に打てない。桂は一段目・二段目に打てない
   - 後手: 歩・香は九段目に打てない。桂は九段目・八段目に打てない

### 1.7 禁じ手

#### (a) 二歩
- 同じ筋に自分の**不成の歩**が2枚以上存在してはならない
- **と金は歩として数えない**（と金がある筋に歩を打つのは合法）

#### (b) 打ち歩詰め
- 持ち駒の歩を打って相手の玉を**詰み**にすること
- 盤上の歩を進めて詰ます「突き歩詰め」は合法
- 歩を打って王手をかけること自体は合法（詰みにならなければ）

#### (c) 行き場のない駒
- 移動後に合法手がなくなるマスへの移動・打ちの禁止
- 1.5の強制成り条件と1.6の打ち禁止に包含される

#### (d) 王手放置
- 自玉に王手がかかっている状態で王手を解除しない手の禁止
- 自玉が相手の利きに入る手（自殺手）の禁止

### 1.8 王手・詰みの定義

#### 王手
相手の玉が自分の駒の利きにある状態。

#### 詰み
玉に王手がかかっていて、以下の全てが不可能な場合:
1. **玉が逃げる**: 安全なマスへ玉を移動
2. **合駒**: 王手している駒と玉の間に駒を打つ/移動して遮る
3. **王手駒を取る**: 王手をかけている駒を取る

### 1.9 千日手

- **盤上の全駒配置** + **両者の持ち駒** + **手番** が全一致する局面が **4回出現** で成立
- 原則として **引き分け（指し直し）**
- **連続王手の千日手**: 片方の手が全て王手だった場合、王手側の **反則負け**

---

## 2. KIF形式仕様

### 2.1 基本情報

- 拡張子: `.kif`（Shift-JIS）、`.kifu`（UTF-8）
- 人間の可読性を重視したフォーマット

### 2.2 ヘッダ

`キーワード：値` 形式（コロンは**全角**）。

| キーワード | 説明 | 例 |
|-----------|------|-----|
| `開始日時` | 対局開始日時 | `2024/01/15 10:00:00` |
| `終了日時` | 対局終了日時 | `2024/01/15 12:30:00` |
| `棋戦` | 棋戦名 | `竜王戦` |
| `戦型` | 戦型名 | `四間飛車` |
| `手合割` | 対局の手合 | `平手` |
| `持ち時間` | 持ち時間 | `各8時間` |
| `秒読み` | 秒読み | `60秒` |
| `場所` | 対局場所 | `東京・将棋会館` |
| `先手` / `下手` | 先手の名前 | `羽生善治` |
| `後手` / `上手` | 後手の名前 | `藤井聡太` |

駒落ち対局の場合は `先手`/`後手` の代わりに `下手`/`上手` を使用。

### 2.3 手合割

| 手合割名 | 説明 |
|---------|------|
| `平手` | 通常の初期配置 |
| `香落ち` | 上手の1一の香を除く |
| `角落ち` | 上手の角行を除く |
| `飛車落ち` | 上手の飛車を除く |
| `飛香落ち` | 上手の飛車と1一の香を除く |
| `二枚落ち` | 上手の飛車と角行を除く |
| `四枚落ち` | 上手の飛角両香を除く |
| `六枚落ち` | 上手の飛角両香両桂を除く |
| `八枚落ち` | 上手の飛角両香両桂両銀を除く |
| `その他` | BOD形式で初期配置を記述 |

### 2.4 BOD形式（初期局面）

手合割が `その他` または任意局面から始める場合に使用:

```
後手の持駒：飛　金二
  ９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
|v香v桂v銀v金v玉v金v銀v桂v香|一
| ・v飛 ・ ・ ・ ・ ・v角 ・|二
|v歩v歩v歩v歩v歩v歩v歩v歩v歩|三
| ・ ・ ・ ・ ・ ・ ・ ・ ・|四
| ・ ・ ・ ・ ・ ・ ・ ・ ・|五
| ・ ・ ・ ・ ・ ・ ・ ・ ・|六
| 歩 歩 歩 歩 歩 歩 歩 歩 歩|七
| ・ 角 ・ ・ ・ ・ ・ 飛 ・|八
| 香 桂 銀 金 玉 金 銀 桂 香|九
+---------------------------+
先手の持駒：なし
```

**表記規則:**
- 先手の駒: ` 駒`（半角スペース＋漢字）
- 後手の駒: `v駒`（小文字v＋漢字）
- 空きマス: ` ・`（半角スペース＋全角中点）
- 成駒: ` 龍`、` 馬`、` と`、` 成銀`、` 成桂`、` 成香`
- 持ち駒: `先手の持駒：飛　金二　歩三`（1枚は数字省略、0枚は`なし`）
- 後手番の場合: `後手番` の行を追加

### 2.5 指し手の表記

#### 区切り行
```
手数----指手---------消費時間--
```

#### フォーマット
```
   1 ７六歩(77)        ( 0:16/00:00:16)
   2 ３四歩(33)        ( 0:05/00:00:05)
   3 ２二角成(88)      ( 0:30/00:00:46)
   4 同　銀(31)        ( 0:10/00:00:15)
   5 ４五角打          ( 1:20/00:02:06)
```

| 要素 | 説明 | 形式 |
|------|------|------|
| 手数 | 連番 | 右詰め半角数字 |
| 移動先 | 筋＋段 | 全角数字＋漢数字（例: `７六`） |
| 「同」 | 直前と同座標 | `同　`（同＋全角スペース） |
| 駒名 | 移動前の駒名 | 漢字 |
| `成` | 成った場合 | `成` |
| `不成` | 成らなかった場合 | `不成` |
| `打` | 持ち駒を打った場合 | `打` |
| 移動元 | 移動元座標 | `(xy)` 半角括弧＋半角数字2桁 |
| 時間 | 消費/累積 | `( m:ss/hh:mm:ss)` |

#### 駒名の漢字表記

| 不成 | 成駒 |
|------|------|
| 玉 | — |
| 飛 | 龍 |
| 角 | 馬 |
| 金 | — |
| 銀 | 成銀 |
| 桂 | 成桂 |
| 香 | 成香 |
| 歩 | と |

### 2.6 コメント

`*` で始まる行がコメント:
```
   5 ４五角打          ( 1:20/00:02:06)
*この手が好手。
   6 ５二金(41)        ( 3:40/00:03:55)
```

### 2.7 終局表記

| 表記 | 意味 |
|------|------|
| `投了` | 投了 |
| `中断` | 中断 |
| `千日手` | 千日手 |
| `持将棋` | 持将棋 |
| `詰み` | 詰み |
| `反則勝ち` | 相手の反則による勝ち |
| `反則負け` | 反則負け |

終局後: `まで79手で先手の勝ち` のような結果行。

### 2.8 KIFサンプル

```
開始日時：2024/01/15 10:00:00
棋戦：練習対局
手合割：平手
先手：先手太郎
後手：後手次郎
手数----指手---------消費時間--
   1 ７六歩(77)        ( 0:01/00:00:01)
   2 ８四歩(83)        ( 0:01/00:00:01)
   3 ２六歩(27)        ( 0:02/00:00:03)
   4 ３二金(41)        ( 0:01/00:00:02)
   5 ７八金(69)        ( 0:01/00:00:04)
   6 投了
まで5手で先手の勝ち
```

---

## 3. SFEN形式仕様

### 3.1 概要

SFEN（Shogi Forsyth-Edwards Notation）はUSI（Universal Shogi Interface）プロトコルで使用される局面表記法。1行の文字列で局面を完全に表現する。

### 3.2 駒の記号

先手=**大文字**、後手=**小文字**。成駒は `+` を前置。

| 駒名 | 先手 | 後手 | 成駒（先手） | 成駒（後手） |
|------|------|------|------------|------------|
| 王将 | `K` | `k` | — | — |
| 飛車 | `R` | `r` | `+R` | `+r` |
| 角行 | `B` | `b` | `+B` | `+b` |
| 金将 | `G` | `g` | — | — |
| 銀将 | `S` | `s` | `+S` | `+s` |
| 桂馬 | `N` | `n` | `+N` | `+n` |
| 香車 | `L` | `l` | `+L` | `+l` |
| 歩兵 | `P` | `p` | `+P` | `+p` |

記号の由来: K=King, R=Rook, B=Bishop, G=Gold, S=Silver, N=kNight, L=Lance, P=Pawn

### 3.3 局面文字列フォーマット

```
[盤面] [手番] [持ち駒] [手数]
```

スペース区切りの4フィールド。

#### 盤面

- 一段目（上端）から九段目（下端）へ、各段は9筋（左）から1筋（右）の順で記述
- 段の区切りは `/`
- 空きマスは連続数を数字（1〜9）で表す

#### 手番

- `b` = 先手（black）の番
- `w` = 後手（white）の番

#### 持ち駒

- なし: `-`
- あり: 駒記号を列挙。2枚以上は数字を前置。先手→後手の順。
  - 例: `S2P` = 先手が銀1枚＋歩2枚
  - 例: `RBG2s3p` = 先手:飛角金、後手:銀2歩3
- 並び順（慣例）: `R > B > G > S > N > L > P`

#### 手数

次の手が何手目か（1始まり）。

### 3.4 初期局面のSFEN

```
lnsgkgsnl/1r5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL b - 1
```

```
lnsgkgsnl   — 一段目: 香桂銀金玉金銀桂香（後手）
1r5b1       — 二段目: ・飛・・・・・角・（後手）
ppppppppp   — 三段目: 歩×9（後手）
9            — 四段目: 空
9            — 五段目: 空
9            — 六段目: 空
PPPPPPPPP   — 七段目: 歩×9（先手）
1B5R1       — 八段目: ・角・・・・・飛・（先手）
LNSGKGSNL   — 九段目: 香桂銀金玉金銀桂香（先手）
```

### 3.5 マスの表記（USI）

- 筋: `1`〜`9`（1=右端、9=左端）
- 段: `a`〜`i`（a=一段、b=二段、...、i=九段）

| 段 | 記号 |
|----|------|
| 一 | `a` |
| 二 | `b` |
| 三 | `c` |
| 四 | `d` |
| 五 | `e` |
| 六 | `f` |
| 七 | `g` |
| 八 | `h` |
| 九 | `i` |

例: `7g` = ７七、`5a` = ５一

### 3.6 指し手の表記（USI）

| 種類 | 形式 | 例 |
|------|------|-----|
| 通常移動 | `[移動元][移動先]` | `7g7f`（７七→７六） |
| 成る | `[移動元][移動先]+` | `8h2b+`（角成） |
| 打つ | `[駒]*[マス]` | `P*2d`（歩を２四に打つ） |

### 3.7 SFEN具体例

#### 初手 ７六歩の後
```
lnsgkgsnl/1r5b1/ppppppppp/9/9/2P6/PP1PPPPPP/1B5R1/LNSGKGSNL w - 2
```

#### 持ち駒ありの例
```
lnsgkgsnl/1r7/pppppp1pp/6p2/9/2P6/PP1PPPPPP/7R1/LNSGKGSNL b B2P 5
```
（先手が角1枚＋歩2枚を持っている）

#### 成駒を含む例
```
lnsgkg1nl/1+R5b1/ppppppppp/9/9/9/PPPPPPPPP/1B5R1/LNSGKGSNL w S 10
```
（`+R` = 龍王）
