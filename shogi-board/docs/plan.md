# 実行計画

将棋盤Vueコンポーネントの実装計画。各フェーズは前フェーズの成果物に依存する。

## 関連ドキュメント

- [将棋ルール・KIF・SFEN仕様](./shogi-rules.md)
- [設計書](./design.md)

---

## フェーズ概要

```
Phase 1: 型定義・定数         ← 全ての土台
    ↓
Phase 2: コアロジック          ← Vue非依存の純粋ロジック
    ↓
Phase 3: UIコンポーネント      ← 盤面表示と操作
    ↓
Phase 4: KIF/SFEN入出力       ← 外部フォーマット対応
    ↓
Phase 5: アプリ統合            ← サンプルアプリとして完成
```

---

## Phase 1: 型定義・定数

### 目標
全モジュールの基盤となる型と定数を定義する。

### 作業内容

| # | ファイル | 内容 |
|---|---------|------|
| 1-1 | `src/core/types.ts` | Player, PieceType, Piece, Position, Board, Hands, Move, GameState 等の型定義 |
| 1-2 | `src/core/constants.ts` | 駒の表示名マッピング、成駒マッピング、各駒の移動ベクトル定義、平手初期配置データ |

### 完了条件
- 全型が定義され、他モジュールからインポート可能
- 初期配置データが正しい（40枚の駒が正しい位置に配置）

---

## Phase 2: コアロジック

### 目標
将棋のルールに従った合法手判定とゲーム進行ロジックを実装する。

### 作業内容

| # | ファイル | 内容 |
|---|---------|------|
| 2-1 | `src/core/moves.ts` | 各駒の移動可能位置計算（走り駒・跳び駒・ステップ駒） |
| 2-2 | `src/core/rules.ts` | 合法手判定: 王手判定、自殺手除外、二歩、打ち歩詰め、行き場のない駒、強制成り、詰み判定 |
| 2-3 | `src/core/game.ts` | ゲーム状態管理: 初期化、手の適用、取った駒→持ち駒、成り処理 |

### 実装順序

```
moves.ts（駒の動き計算）
    ↓
rules.ts（合法手フィルタリング。moves.tsに依存）
    ↓
game.ts（ゲーム進行。moves.ts, rules.tsに依存）
```

### 合法手判定の実装方針

1. 指定された駒の移動可能マスを `moves.ts` で計算（味方の駒がいるマスを除外）
2. 各移動候補について仮に手を指し、自玉が王手されているかチェック → 自殺手を除外
3. 持ち駒を打つ場合: 空きマス判定 → 行き場のない駒チェック → 二歩チェック → 打ち歩詰めチェック
4. 成りの判定: mandatory / optional / none を決定

### 完了条件
- 全駒の移動計算が正しく動作
- 禁じ手（二歩・打ち歩詰め・王手放置・行き場のない駒）が正しく弾かれる
- 駒の取得と持ち駒追加が正しく動作

---

## Phase 3: UIコンポーネント

### 目標
盤面表示、駒の選択・移動UIを構築する。

### 作業内容

| # | ファイル | 内容 |
|---|---------|------|
| 3-1 | `src/components/Piece.vue` | 駒表示（漢字、向き、成駒の色） |
| 3-2 | `src/components/Square.vue` | マス（駒表示、ハイライト、クリック） |
| 3-3 | `src/components/Board.vue` | 9×9盤面（CSS Grid、星の表示） |
| 3-4 | `src/components/Hand.vue` | 持ち駒エリア（駒種×枚数、クリック選択） |
| 3-5 | `src/components/GameInfo.vue` | 手番表示、手数、SFEN表示 |
| 3-6 | `src/composables/useGameState.ts` | リアクティブなゲーム状態管理 |
| 3-7 | `src/composables/useSelection.ts` | 駒選択・移動先選択のUI状態管理 |
| 3-8 | `src/components/ShogiBoard.vue` | 全体を統合するメインコンポーネント |

### 実装順序

```
Piece.vue → Square.vue → Board.vue  （表示の積み上げ）
    ↓
Hand.vue                             （持ち駒エリア）
    ↓
useGameState.ts → useSelection.ts    （状態管理）
    ↓
ShogiBoard.vue                       （統合）
    ↓
GameInfo.vue                         （付随情報）
```

### 完了条件
- 平手初期配置が正しく表示される
- 駒をクリックすると合法移動先がハイライトされる
- 合法移動先をクリックすると駒が移動する
- 成りが必要な場合にダイアログ/選択が表示される
- 持ち駒の表示と打ちが正しく動作する
- 非合法手は指せない

---

## Phase 4: KIF/SFEN入出力

### 目標
外部フォーマットとの相互変換を実装する。

### 作業内容

| # | ファイル | 内容 |
|---|---------|------|
| 4-1 | `src/core/sfen.ts` | SFEN→GameState パーサー、GameState→SFEN シリアライザー、USI指し手の変換 |
| 4-2 | `src/core/kif.ts` | KIF→GameState パーサー（ヘッダ・指し手・コメント解析）、GameState→KIF シリアライザー |

### 実装順序

```
sfen.ts（SFENはシンプルなので先に）
    ↓
kif.ts（KIFはSFENより複雑。SFEN初期局面対応にsfen.tsを活用可能）
```

### 完了条件
- 任意のSFEN文字列から盤面を復元できる
- 現在の盤面をSFEN文字列に変換できる
- KIFファイルを読み込んで対局を再現できる
- 対局結果をKIF形式で出力できる

---

## Phase 5: アプリ統合

### 目標
全機能を統合したサンプルアプリケーションを完成させる。

### 作業内容

| # | ファイル | 内容 |
|---|---------|------|
| 5-1 | `src/App.vue` | サンプルアプリのメイン画面 |
| 5-2 | `src/style.css` | グローバルスタイル |
| 5-3 | 既存ファイルの整理 | 不要なHelloWorld.vue等の削除 |

### App.vueの構成

```
┌─────────────────────────────────────────┐
│  将棋盤サンプル                           │
├──────────────────┬──────────────────────┤
│                  │  SFEN:              │
│   [ShogiBoard]   │  lnsgkgsnl/...      │
│                  │                      │
│                  │  [SFEN コピー]       │
│                  │  [KIF 出力]          │
│                  │  [KIF 読込]          │
│                  │  [リセット]           │
│                  │                      │
│                  │  手番: 先手           │
│                  │  手数: 1             │
└──────────────────┴──────────────────────┘
```

### 完了条件
- アプリが起動し、平手初期配置が表示される
- 対局が最初から最後まで行える
- SFENのコピー機能が動作する
- KIFの入出力が動作する
- ビルドがエラーなく完了する

---

## 実装上の注意事項

### イミュータビリティ
- ゲーム状態は手の適用ごとに新しいオブジェクトを生成する（直接変更しない）
- これにより undo や履歴管理が容易になる

### 後手の駒の方向
- 内部ロジックでは駒の移動方向を先手基準で定義し、後手の場合は `dy` を反転させる
- UIでは後手の駒を `transform: rotate(180deg)` で表示する

### 座標系の統一
- 内部表現: `(row, col)` = `(0-8, 0-8)`、row=0が一段（上端）、col=0が9筋（左端）
- 将棋表記への変換: `筋 = 9 - col`、`段 = row + 1`
- SFEN表記への変換: `file = 9 - col`、`rank = String.fromCharCode('a'.charCodeAt(0) + row)`

### パフォーマンス
- 合法手計算は `shallowRef` + `computed` で必要時のみ再計算
- 81マスの再描画を抑制するため `Square.vue` で `:key` を適切に設定
